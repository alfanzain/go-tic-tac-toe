<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tic Tac Toe</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center">
    <a href="http://localhost:3000" class="mb-8">Home</a>
    <!-- Copy Room Link -->
    <div class="mb-6">
        <label class="block text-gray-600 mb-2 font-medium">Room Link</label>
        <div class="flex items-center gap-2 justify-center">
            <input id="roomLink" type="text" readonly
                class="w-72 px-3 py-2 border border-gray-300 rounded-md text-sm text-gray-700 bg-gray-100" />
            <button id="copyBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm">
                Copy
            </button>
        </div>
        <p id="copyStatus" class="text-green-600 mt-2 text-sm hidden">Link copied!</p>
    </div>

    <div class="flex flex-col items-center w-full max-w-[500px] p-4 bg-white rounded-lg shadow-md">
        <div id="hud" class="flex flex-row w-full justify-between mx-auto mt-2 mb-4 border-b-2 border-gray-300">
            <div id="hudPlayerInfo">
                <span id="hudPlayerInfoName" class="flex text-lg justify-items-start text-left" />
            </div>
            <div id="hudOpponentInfo">
                <span id="hudOpponentInfoName" class="flex text-lg justify-items-start text-right" />
            </div>
        </div>
        <div class="text-center">
            <h1 class="text-3xl font-bold mb-6">Tic Tac Toe</h1>
            <div id="board" class="grid grid-cols-3 gap-2 w-60 mx-auto mb-4">
                <!-- Cells will be generated by JS -->
            </div>
            <p id="status" class="mb-4 text-lg font-medium text-gray-700"></p>
        </div>
    </div>

    <script>
        const roomLinkInput = document.getElementById("roomLink")
        const copyBtn = document.getElementById("copyBtn")
        const copyStatus = document.getElementById("copyStatus")


        const hudPlayerInfo = document.getElementById("hudPlayerInfo")
        const hudOpponentInfo = document.getElementById("hudOpponentInfo")
        const hudPlayerInfoName = document.getElementById("hudPlayerInfoName")
        const hudOpponentInfoName = document.getElementById("hudOpponentInfoName")
        const boardEl = document.getElementById('board')
        const statusText = document.getElementById('status')

        let ws
        let room = null
        let player = null
        let opponent = null

        let currentTurn = 'X'
        let cells = Array(9).fill('')
        let gameStatus = "wait"
        let gameOver = false
        const cellData = {
            0: { row: 0, col: 0 },
            1: { row: 0, col: 1 },
            2: { row: 0, col: 2 },
            3: { row: 1, col: 0 },
            4: { row: 1, col: 1 },
            5: { row: 1, col: 2 },
            6: { row: 2, col: 0 },
            7: { row: 2, col: 1 },
            8: { row: 2, col: 2 }
        }

        const path = window.location.pathname
        const pathParts = path.split("/")
        const roomId = pathParts[2]

        const roomLink = `${window.location.origin}/room/${roomId}`
        roomLinkInput.value = roomLink

        copyBtn.addEventListener("click", () => {
            navigator.clipboard.writeText(roomLink)
                .then(() => {
                    copyStatus.classList.remove("hidden")
                    setTimeout(() => copyStatus.classList.add("hidden"), 2000)
                })
        })

        const loadHud = () => {
            hudPlayerInfoName.textContent = `${player.name} (You)`
            hudOpponentInfoName.textContent = opponent ? `${opponent.name}` : `Waiting opponent...`
        }

        const initWs = () => {
            ws = new WebSocket(`ws://localhost:3000/room/${roomId}/socket`)

            // ! TODO: learn so I can get initial message from onopen, not from onmessage
            // ws.onopen = (event) => {
            //   console.log(event)
            // };

            ws.onmessage = (event) => {
                const message = JSON.parse(event.data)

                // if message
                if (message?.message_type) {
                    if (message?.message_type == "game_info") {
                        player = message.data.player

                        opponent = message.data.room.players.find(opponent => {
                            return opponent?.id !== player.id
                        })

                        loadHud()
                    }
                }

                // if action
                if (message?.action_type) {
                    gameStatus = message.data.status

                    initGame(message)
                    changeTurn(message)

                    renderBoard(message.data.board)
                }
            }

            ws.onclose = () => {
                alert("You are disconnected!")
            }
        }

        const initGame = (message) => {
            if (message?.action_type == "init") {
                gameStatus = message.data.status
                changeStatusText()

                renderBoard(message.data.board)
            }
        }

        const changeTurn = (message) => {
            if (message?.action_type == "move" || message?.action_type == "end") {
                if (message?.data?.side == "X") {
                    currentTurn = 'O'
                } else {
                    currentTurn = 'X'
                }
                
                changeStatusText()
            }
        }
        
        const changeStatusText = () => {
            if (gameStatus != "ongoing") {
                statusText.textContent = `${gameStatus}`
            } else {
                if (currentTurn == player.side) {
                    statusText.textContent = `Your turn (${currentTurn})`
                } else {
                    statusText.textContent = `Opponent turn (${currentTurn})`
                }
            }
        }
        const handleClick = (e) => {
            const index = e.target.dataset.index
            if (cells[index] || gameOver) return

            cells[index] = currentTurn
            e.target.textContent = currentTurn

            ws.send(JSON.stringify({
                "action_type": "move",
                "data": {
                    // "side": currentTurn,
                    "position": cellData[index],
                    "board": [],
                    "status": gameStatus,
                    "actor": {
                        "id": player.id,
                        "name": player.name
                    },
                }
            }))
        }

        const renderBoard = (board) => {
            boardEl.innerHTML = ''
            
            let i = 0;
            for (let row of board) {
                for (let cell of row) {
                    const cellEl = document.createElement('div')
                    cellEl.className = 'w-20 h-20 bg-white border-2 border-gray-300 flex items-center justify-center text-2xl font-bold'
                    cellEl.dataset.index = i

                    if (cell != "" || player.side != currentTurn || gameStatus != "ongoing") {
                        cellEl.textContent = cell
                        cellEl.classList.add('cursor-not-allowed')
                        cellEl.onclick = null
                    } else {
                        cellEl.textContent = ''
                        cellEl.classList.add('cursor-pointer')
                        cellEl.onclick = handleClick
                    }

                    boardEl.appendChild(cellEl)
                    i++
                }
            }
        }

        initWs()
    </script>
</body>

</html>